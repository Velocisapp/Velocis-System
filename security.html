<!DOCTYPE html>
<html>
<head>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: -apple-system, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        #search-overlay {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: white; padding: 12px; border-radius: 12px;
            display: flex; gap: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        input { border: 1px solid #ddd; padding: 12px; border-radius: 8px; width: 200px; outline: none; }
        button { background: #007AFF; color: #fff; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* THE DYNAMIC BEACON */
        .velocis-marker {
            width: 20px; height: 20px; background: #00f2ff; border: 3px solid white;
            border-radius: 50%; box-shadow: 0 0 15px #00f2ff;
        }
    </style>
</head>
<body>

<div id="search-overlay">
    <input type="text" id="user-query" placeholder="Search Gate or Shop...">
    <button id="search-btn">NAVIGATE</button>
</div>
<div id="map"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoidmVsb2Npc2RldmVsb3BlciIsImEiOiJjbWtyanA4NHcxNHk0M2twcXNibXhvdnVhIn0.9sLk_qMET9czvmbYPZ9Bkg';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11', // Optimized for POI visibility
        center: [-80.2831, 25.7960],
        zoom: 17, pitch: 60, antialias: true
    });

    const marker = new mapboxgl.Marker(document.createElement('div'));

    // THE DYNAMIC SEARCH ALGORITHM
    async function searchMapRegistry(query) {
        // 1. Zoom to the general airport area to force the 3D data to download
        map.easeTo({ center: [-80.2831, 25.7960], zoom: 18 });

        // 2. Wait for the map to be "Idle" (Data is finished downloading)
        map.once('idle', () => {
            // 3. UNIVERSAL HARVESTING: Look through all active labels (Gates + Shops)
            const features = map.queryRenderedFeatures();
            
            const match = features.find(f => 
                f.properties.name && f.properties.name.toUpperCase().includes(query.toUpperCase())
            );

            if (match) {
                const coords = match.geometry.coordinates;
                
                // 4. THE GUIDANCE SNAP
                map.flyTo({
                    center: coords,
                    zoom: 20,
                    pitch: 75,
                    duration: 3000,
                    essential: true
                });

                // Drop the beacon on the dynamic result
                const el = document.createElement('div');
                el.className = 'velocis-marker';
                marker.setElement(el).setLngLat(coords).addTo(map);
            } else {
                alert("Target not found. Please ensure you are looking for a Gate (D34) or a Shop (Starbucks).");
            }
        });
    }

    document.getElementById('search-btn').addEventListener('click', () => {
        const query = document.getElementById('user-query').value.trim();
        if (query) searchMapRegistry(query);
    });

    map.on('style.load', () => {
        map.setConfigProperty('basemap', 'lightPreset', 'day');
    });
</script>
</body>
</html>
