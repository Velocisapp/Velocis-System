<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VELOCIS™ | MISSION CONTROL</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        :root { --v-blue: #007AFF; --cyan: #00FBFF; --glass: rgba(255, 255, 255, 0.98); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, sans-serif; background: #000; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        .passenger-chevron {
            width: 60px; height: 60px;
            filter: drop-shadow(0px 10px 15px rgba(0, 251, 255, 1));
            display: flex; align-items: center; justify-content: center;
        }

        #ui-header { 
            position: absolute; top: 0; width: 100%; height: 64px; 
            background: var(--glass); display: flex; align-items: center; 
            justify-content: space-between; padding: 0 24px; z-index: 10; box-sizing: border-box; 
        }

        #mission-btn {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            padding: 18px 45px; background: var(--v-blue); color: white; border: none;
            border-radius: 18px; font-weight: 800; font-size: 18px; cursor: pointer;
            z-index: 100; box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="ui-header">
        <div style="font-weight:900; font-size: 20px;">VELOCIS<span style="color:var(--v-blue); font-weight:200;">™</span></div>
        <div style="background:#000; color:#fff; padding:6px 14px; border-radius:20px; font-size:10px; font-weight:900;">IPS SYNTHETIC ENGINE</div>
    </div>

    <button id="mission-btn" onclick="executeMission()">START INDOOR WAYFINDING</button>
    <div id="map"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoidmVsb2Npc2RldmVsb3BlciIsImEiOiJjbWtyanA4NHcxNHk0M2twcXNibXhvdnVhIn0.9sLk_qMET9czvmbYPZ9Bkg';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11', 
            center: [-80.2835, 25.7958], 
            zoom: 18.8, pitch: 0, bearing: 0, antialias: true
        });

        // ARCHITECTURAL GRAPH NODES (MIA Concourse D)
        const waypoints = [
            [-80.2845, 25.7954], // NODE A: CURB DROP-OFF
            [-80.2838, 25.7957], // NODE B: CHECK-IN HALLWAY
            [-80.2831, 25.7959], // NODE C: SECURITY RADIUS
            [-80.2824, 25.7962], // NODE D: CONCOURSE D CENTER
            [-80.2818, 25.7965]  // NODE E: GATE D20
        ];

        map.on('load', () => {
            // 1. FIX TRANSPARENCY: Solid Architectural Footprint
            map.addLayer({
                'id': 'solid-terminal',
                'source': 'composite', 'source-layer': 'building',
                'type': 'fill-extrusion',
                'paint': {
                    'fill-extrusion-color': '#FFFFFF',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-opacity': 1.0 
                }
            });

            // 2. THE THREAD: Single Line Mission
            map.addSource('route-source', {
                'type': 'geojson',
                'data': { 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': waypoints } }
            });

            map.addLayer({
                'id': 'route-line',
                'type': 'line',
                'source': 'route-source',
                'paint': {
                    'line-color': '#00FBFF',
                    'line-width': 4,
                    'line-opacity': 1
                }
            });
        });

        function executeMission() {
            document.getElementById('mission-btn').style.display = 'none';

            const el = document.createElement('div');
            el.className = 'passenger-chevron';
            el.innerHTML = `
                <svg width="60" height="60" viewBox="0 0 100 100">
                    <path d="M50 0 L95 100 L50 82 L5 100 Z" fill="#00FBFF" stroke="#000" stroke-width="3"/>
                </svg>`;
            
            const marker = new mapboxgl.Marker({ element: el, rotationAlignment: 'map' })
                .setLngLat(waypoints[0])
                .addTo(map);

            // 3. INTERNAL ANIMATION (Ignoring Outdoor World)
            let step = 0;
            function run() {
                if (step < 1) {
                    const i = Math.floor(step * 4);
                    const next = i + 1;
                    const t = (step * 4) - i;
                    const lng = waypoints[i][0] + (waypoints[next][0] - waypoints[i][0]) * t;
                    const lat = waypoints[i][1] + (waypoints[next][1] - waypoints[i][1]) * t;
                    
                    marker.setLngLat([lng, lat]);
                    marker.setRotation(Math.atan2(waypoints[next][0]-waypoints[i][0], waypoints[next][1]-waypoints[i][1])*180/Math.PI);
                    
                    step += 0.002;
                    requestAnimationFrame(run);
                }
            }
            run();
            map.flyTo({ center: [-80.2825, 25.7962], zoom: 19.5, speed: 0.8 });
        }
    </script>
</body>
</html>
